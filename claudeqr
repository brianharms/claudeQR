#!/bin/bash
# claudeqr — Launch Claude Code with phone remote control
# Usage: claudeqr [claude args...]
# Supports multiple simultaneous instances (unique session + port per window)

# Resolve symlinks to get the real project directory
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0" 2>/dev/null || realpath "$0" 2>/dev/null || echo "$0")")" && pwd)"

# Generate a unique instance ID (short random hex)
INSTANCE_ID=$(hexdump -n 3 -e '3/1 "%02x"' /dev/urandom)
SESSION_NAME="clq-${INSTANCE_ID}"
TMP_PREFIX="/tmp/claudeqr-${INSTANCE_ID}"
LOG="${TMP_PREFIX}-server.log"

# Find an available port starting from 3456
PORT=3456
while lsof -ti:$PORT &>/dev/null; do
  PORT=$((PORT + 1))
done

cleanup() {
  # Only tear down the server if the tmux session is gone.
  # If the user just detached, the session (and Claude) are still alive
  # and the server needs to keep running for the QR feature.
  if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    if [ -n "$SERVER_PID" ]; then
      kill "$SERVER_PID" 2>/dev/null
    fi
    rm -f "${TMP_PREFIX}"-*
  fi
}
trap cleanup EXIT

# Create the tmux session with a clean environment (strip CLAUDECODE var)
tmux new-session -d -s "$SESSION_NAME" -x "$(tput cols)" -y "$(tput lines)" \
  "env -u CLAUDECODE zsh -l"

# Give the shell a moment to initialize
sleep 1

# Start the web server in the background (log output for debugging)
CLAUDEQR_SESSION="$SESSION_NAME" CLAUDEQR_PORT="$PORT" CLAUDEQR_INSTANCE="$INSTANCE_ID" \
  node "$SCRIPT_DIR/server.js" > "$LOG" 2>&1 &
SERVER_PID=$!

# Wait for server to be ready
for i in $(seq 1 40); do
  if lsof -ti:$PORT &>/dev/null; then
    break
  fi
  sleep 0.25
done

# Bind Ctrl+B, r to instantly show the QR code (no AI round trip)
tmux bind-key -T prefix r split-pane -vb -l 22 \
  bash "$SCRIPT_DIR/show-qr.sh" "$INSTANCE_ID"

# Start Claude Code inside the tmux session, passing through all args
tmux send-keys -t "$SESSION_NAME" "claude $*" Enter

# Attach to the tmux session — user sees Claude in their terminal as usual
tmux attach -t "$SESSION_NAME"
